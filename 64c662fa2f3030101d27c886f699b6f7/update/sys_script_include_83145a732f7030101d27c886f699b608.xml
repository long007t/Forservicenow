<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>package_private</access>
        <active>true</active>
        <api_name>x_545827_slack_std.ServiceNowForSlackUtils</api_name>
        <caller_access/>
        <client_callable>false</client_callable>
        <description>This utility class will have methods will be used across various script actions e.g. calling external endpoints, common database calls etc.</description>
        <name>ServiceNowForSlackUtils</name>
        <script><![CDATA[var ServiceNowForSlackUtils = Class.create();
ServiceNowForSlackUtils.prototype = {
    initialize: function() {
    },
	
	getBulkAlertsSubscriptions: function(recordType, subscriptionType) {
		var subscriptions = new GlideRecord('x_545827_slack_std_slack_subscriptions'); 
		subscriptions.addQuery('record_type', recordType);
		subscriptions.addQuery('subscription_type', subscriptionType);
		subscriptions.addQuery('level', "object");
		subscriptions.addQuery('is_active', true);
		subscriptions.query(); 
		return subscriptions;
	},
	
	getRecordAlertsSubscriptions: function(recordType, subscriptionType, recordId) {
		var subscriptions = new GlideRecord('x_545827_slack_std_slack_subscriptions'); 
		subscriptions.addQuery('record_type', recordType);
		subscriptions.addQuery('subscription_type', subscriptionType);
		subscriptions.addQuery('level', "record");
		subscriptions.addQuery('record_id', recordId);
		subscriptions.addQuery('is_active', true);
		subscriptions.query(); 
		return subscriptions;
	},
	
	getSlackNotificationRecord: function(subscriptions, current) {
		var record = {
			sys_id: subscriptions.getValue("sys_id"), // subsription_id
			record_id: current.getValue("sys_id"), // record type sys id
			slack_team_id: subscriptions.getValue("slack_team_id"),
			number: current.getValue("number"),
			short_description: current.getValue("short_description"),
			record_type: subscriptions.getValue("record_type"),
			record_type_name: current.sys_class_name.getDisplayValue(),
			subscription_type: subscriptions.getValue("subscription_type"),
			level: subscriptions.getValue("level"),
		};
		return record;
	},
	
	sendSlackNotification: function(record) {
		var response = null;
		// get the api key
		var notificationsAuth = new GlideRecord('x_545827_slack_std_servicenow_for_slack_notifications_auth'); 
		var isApiKeyExists = notificationsAuth.get('slack_team_id', record.slack_team_id); 

		if (isApiKeyExists) {
			var slackNotifyRestMessage = new sn_ws.RESTMessageV2();
			slackNotifyRestMessage.setEndpoint('https://slack.com/interop-apps/servicenow/slack/notification');
			slackNotifyRestMessage.setHttpMethod('post');
			slackNotifyRestMessage.setRequestHeader('Api-Key', notificationsAuth.api_key);
			slackNotifyRestMessage.setRequestHeader('Content-Type',"application/json");
			slackNotifyRestMessage.setRequestBody(JSON.stringify(record));
			try {
				response = slackNotifyRestMessage.execute();
				gs.info("Response status - " + response.getStatusCode() + " from endpoint for record - " +
						JSON.stringify(record));
			} catch(error) {
				gs.error("Error calling Slack Api for record - " + JSON.stringify(record), error);
			}
		} else {
			gs.info("Discarding Request as user has not authenticated app for record - " + JSON.stringify(record));
		}	
		
		return response;
	},

    type: 'ServiceNowForSlackUtils'
};]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2021-06-24 08:48:08</sys_created_on>
        <sys_id>83145a732f7030101d27c886f699b608</sys_id>
        <sys_mod_count>38</sys_mod_count>
        <sys_name>ServiceNowForSlackUtils</sys_name>
        <sys_package display_value="ServiceNow for Slack Notifications" source="x_545827_slack_std">64c662fa2f3030101d27c886f699b6f7</sys_package>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="ServiceNow for Slack Notifications">64c662fa2f3030101d27c886f699b6f7</sys_scope>
        <sys_update_name>sys_script_include_83145a732f7030101d27c886f699b608</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2021-08-26 08:24:03</sys_updated_on>
    </sys_script_include>
</record_update>
